---
title: "European data status"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(gh)
library(dplyr)
library(stringr)
library(lubridate)
library(here)
library(readr)
library(tibble)
library(countrycode)
library(ggplot2)
library(scales)
library(scales)
```

## Truth data

### Hospitalisations

```{r hospitalisations, echo=FALSE, message=FALSE}
hosp_data <- readr::read_csv(here::here(
  "data-truth", "OWID", "truth_OWID-Weekly Incident Hospitalizations.csv"
  ),
  show_col_types = FALSE
) |>
  filter(target_end_date >= max(snapshot_date) - lubridate::weeks(8))
hosp_locations <- sort(unique(hosp_data$location_name))
```


- `r hosp_locations`

```{r hosp-data-warnings}
if (nrow(hosp_data > 0)) {
  gaps <- hosp_data %>%
    group_by(location_name) %>%
    slice_max(snapshot_date, n = 1) %>%
    ungroup() %>%
    mutate(date_diff = max(snapshot_date) - snapshot_date) %>%
    filter(snapshot_date < max(snapshot_date) & date_diff > 14) %>%
    pull(location_name)
  show_text_gaps <- length(gaps) > 0
} else {
  cat("--- Recent data unavailable ---")
}
```

```{r, eval=show_text_gaps, results="asis"}
if (length(gaps) > 0) {
  cat(
    "- **Data warning!** Recent missing data in:",
    knitr::combine_words(gaps), "\n"
  )
}
```

The Hub validates and evaluates forecasts against data collated by [Our World in Data](https://ourworldindata.org/covid-hospitalizations), provided in the [OWID](OWID) directory.
These data are provided as reported by national health authorities and therefore are not consistent in definition, and care needs to be taken in interpreting them.

One particular issue that affects several of the hospitalisation data streams it the one of right truncation.
This occurs when these are reported with a delay, and therefore recent data need to be treated as incomplete, posing additional challenges to forecasting such data streams and validating forecasts.

For our visualisations and assesments of forecast performance we treat hospitalisation as *final* 28 days after the reported date.
Any further revisions will be ignored for the purposes of the Hub.

We provide multiple views of the data in order to facilitate modelling of COVID-19 hospitalisations with a 28 day cutoff.
In the [snapshot](OWID/snapshot) directory we provide daily snapshots of the COVID-19 hospitalisation data as collated by Our World in Data, before any further processing is applied.
The data in there are given either as rolling weekly sums of daily data, or weekly data.
In the [final](OWID/final) directory we provide data that are considered "final", i.e. they stop 28 days before the latest date.
The files in this directory are the ones used for scoring the forecasts for their performance against observed data.

The single dataset in [OWID/truth_OWID-Incident Hospitalizations.csv](OWID/truth_OWID-Incident Hospitalizations.csv) contains the latest data, where the final versions of the data are included for dates more than 28 days before the latest snapshot date, and the most recent version for any subsequent data.
This is the dataset recommended for use in models that can take into account the truncation of the data. Please note that the data reported at weekly frequency has been shifted back one day to Saturday (instead of Sunday) in that file to comply with the Hub definition of an epidemiological week (Sunday-Saturday).

We further provide a set of [recommended cutoffs](OWID/recommended-cutoffs.csv) for use with these data.
These are estimates of the truncation in the number of weeks that should be cut off the data set if the aim is to have a data set that is not further revised by more than 5%.
The corresponding dataset in [OWID/truncated_OWID-Incident Hospitalizations.csv](OWID/truth_OWID-Incident Hospitalizations.csv) has these recent weeks removed and is recommended for use in models that cannot take into account the truncation of the data.

The latest hospitalisation data is plotted below, with the dashed line indicating data expecting to be substanially revised.

```{r weekly_hosp_data, echo = FALSE}
duplicate_final <- hosp_data |>
  dplyr::group_by(location, location_name, source) |>
  dplyr::filter(any(status == "expecting revisions"),
                status != "expecting revisions") |>
  dplyr::filter(target_end_date == max(target_end_date)) |>
  dplyr::ungroup() |>
  dplyr::mutate(status = "expecting revisions")
hosp_data <- hosp_data |>
  bind_rows(duplicate_final)

p <- ggplot2::ggplot(
       hosp_data |> filter(status != "expecting revisions"),
       ggplot2::aes(x = target_end_date, y = value)
  ) +
  ggplot2::geom_line() +
  ggplot2::geom_line(
    data = hosp_data |> filter(status == "expecting revisions"),
    linetype = "dashed"
  ) +
  ggplot2::scale_y_continuous(labels = scales::comma) +
  ggplot2::scale_x_date(breaks = scales::breaks_pretty(4),
                        labels = scales::label_date_short()) +
  ggplot2::facet_wrap(. ~ location_name, scales = "free_y") +
  ggplot2::theme_bw() +
  ggplot2::ylab("Weekly number of hospitalisations") +
  ggplot2::xlab("End date of week") +
  ggplot2::expand_limits(y = 0)
ggplot2::ggsave("plots/hospitalisations.svg", p, width = 10.5, height = 7.5)
```

![Plot of hospitalisations](plots/hospitalisations.svg)


### Cases and deaths

We further evaluate forecasts of cases and deaths against [Johns Hopkins University data](https://github.com/CSSEGISandData/COVID-19), and we recommend using this dataset as the basis for forecasts.

-   Daily numbers of cases and deaths are available to download from [JHU](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series), or from [our repository](https://github.com/epiforecasts/covid19-forecast-hub-europe/data-truth).
-   JHU also provide [country metadata](https://github.com/CSSEGISandData/COVID-19/blob/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv), including population counts and ISO-3 codes.

Note there are some differences between the format of the JHU data and what we require in a forecast. Please check the [Wiki](https://github.com/epiforecasts/covid19-forecast-hub-europe/wiki/Targets-and-horizons#truth-data) for more on forecast formatting.

#### Potential issues in the JHU dataset

As of `r Sys.Date()`

```{r issues, echo=FALSE, message=FALSE}

# Get locations
locations <- pull(
  read_csv(here::here("data-locations", "locations_eu.csv"), show_col_types = FALSE),
  location
)
countries <- countrycode::codelist %>%
  filter(iso2c %in% locations) %>%
  select(fips, country.name.en) %>%
  mutate(fips = str_to_lower(fips),
         country.name.en = str_to_lower(country.name.en))
country_ch <- c(countries$fips, countries$country.name.en)
country_ch <- country_ch[!country_ch %in% c("be", "no")]
country_ch <- paste0("\\b", country_ch, "\\b", collapse = "|")

# Get issues in last six weeks
issues <- gh("GET /repos/CSSEGISandData/COVID-19/issues", 
             username = "CSSEGISandData",
             state = "open",
             since = Sys.Date() - (7*8), 
             sort = "updated", 
             per_page = 100)
# Get matching issues
issues <- tibble::tibble("issue" = vapply(issues, "[[", "", "title"),
                         # we cannot use vapply() for the issue body because it
                         # might be empty (i.e., NULL)
                         "message" = sapply(issues, "[[", "body"), 
                         "url" = vapply(issues, "[[", "", "html_url"),
                         "created" = as.Date(vapply(issues, "[[", "", "created_at")),
                         "updated" = as.Date(vapply(issues, "[[", "", "updated_at"))) %>%
  mutate(issue = str_to_lower(issue),
         message = str_replace_all(message, "\\r\\n", " "),
         message = str_c(str_sub(message, start = 1, end = 50), "..."),
         country = str_extract(issue, country_ch)) %>%
  filter(str_detect(issue, country_ch) &
         str_detect(url, "issues")) %>%
  select(country, created, updated, issue, message, url) %>%
  group_by(country) %>%
  arrange(desc(updated))

knitr::kable(issues, escape = FALSE)

```

Open issues updated over the last eight weeks: from [JHU CSSEGISandData Github](https://github.com/CSSEGISandData/COVID-19/)

## Additional data sources

We do not use or evaluate against these data, but the following might be useful for modelling targets:

| Data                | Description                                                                                                                              | Source | Link                                                                                                                            |
|---------------------|------------------------------------------------------------------------------------------------------------------------------------------|--------|---------------------------------------------------------------------------------------------------------------------------------|
| Vaccination         | Number of vaccine doses distributed by manufacturers, number of first, second and unspecified doses administered                         | ECDC   | [Data on COVID-19 vaccination in the EU/EEA](https://www.ecdc.europa.eu/en/publications-data/data-covid-19-vaccination-eu-eea)  |
| Variants of concern | Volume of COVID-19 sequencing, the number and percentage distribution of VOC for each country, week and variant submitted since 2020-W40 | ECDC   | [Data on SARS-CoV-2 variants in the EU/EEA](https://www.ecdc.europa.eu/en/publications-data/data-virus-variants-covid-19-eueea) |
| Testing             | Weekly testing rate and weekly test positivity                                                                                           | ECDC   | [Data on testing for COVID-19 by week and country](https://www.ecdc.europa.eu/en/publications-data/covid-19-testing)            |


