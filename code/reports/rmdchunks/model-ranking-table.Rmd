```{r, results = 'asis'}
df <- table %>%
  filter(target_variable == target_variables[variable],
         horizon == this_horizon)

model_df <- df %>%
  filter(model == params$model)

if (all(is.na(model_df$rel_wis))) {
  cat("Skill is shown as relative absolute error; weighted interval score",
      "is not calculated as the 23 quantile levels required are not being",
      "provided by the model.")
  df <- df %>%
    rename(skill = rel_ae)
  model_df <- model_df %>%
    rename(skill = rel_ae)
} else {
  cat("Skill is shown as weighted interval score.")
  df <- df %>%
    rename(skill = rel_wis)
  model_df <- model_df %>%
    rename(skill = rel_wis)
}

if (nrow(model_df) > 0) {
  cat("The table shows the skill of the ", params$model,
      "model (`Model skill`), the ensemble model (`Ensemble skill`), and",
      "the best individual model (`Best skill`).\n")

  top_ranked <- df %>%
    group_by(location_name) %>%
    slice(which.min(skill)) %>%
    ungroup() %>%
    select(location_name, `Best skill` = skill)

  ## if not doing the ensemble, show the ensemble
  if (!grepl("hub-ensemble$", params$model)) {
    ensemble <- df %>%
      filter(grepl("hub-ensemble$", model)) %>%
      select(location_name, `Ensemble skill` = skill)
    top_ranked <- ensemble %>%
      inner_join(top_ranked, by = "location_name")
  }

  final_df <- model_df %>%
    select(location_name, `Model skill` = skill) %>%
    inner_join(top_ranked, by = "location_name")

  ## we want NA to be sorted as a high number, see https://stackoverflow.com/a/65897972
  render <- JS(
    "function(data, type, row) {",
    "  if(type === 'sort' && data === null) {",
    "    return Infinity;",
    "  }",
    "  return data;",
    "}"
  )

  final_df %>%
    select(Location = location_name, ends_with(" skill")) %>%
    arrange(Location) %>%
    DT::datatable(
      width = "100%",
      options = list(
        paging = FALSE,
        info = FALSE,
        buttons = c('csv', 'excel'),
        dom = 'Bfrtip',
        scrollX = TRUE,
        fixedColumns = TRUE,
        columnDefs = list(
          list(targets = seq(1, ncol(.) - 1), render = render)
        )
      ),
      rownames = FALSE
    )
} else {
  cat(" Scores are only created for models that were used for forecasts in each of the last 4 weeks, excluding periods during which there were anomalies in the data. At the moment the model does not fulfill that criterion." )
}
```
